<html>

<head>
    <script src="node_modules/@microsoft/signalr/dist/browser/signalr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.min.js"></script>
    <script
        src="https://code.jquery.com/jquery-3.4.1.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" />
    <link rel="stylesheet" href="site.css" />
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
</head>

<body onload="start();">

    <div class="ui three steps">
        <div class="step" id="reception">
            <i class="inbox icon" id="reception-icon" data-icon="inbox"></i>
            <div class="content">
                <div class="title">Loan Reception</div>
                <div class="description">Initial validation on the loan application</div>
            </div>
        </div>
        <div class="step" id="agencies">
            <i class="sitemap icon" id="agencies-icon" data-icon="sitemap"></i>
            <div class="content">
                <div class="title">Agency Validation</div>
                <div class="description">Check external credit agencies</div>
            </div>
        </div>
        <div class="step" id="confirmation">
            <i class="info icon" id="confirmation-icon" data-icon="info"></i>
            <div class="content">
                <div class="title">Loan Approval</div>
                <div class="description">Final result of the loan application</div>
            </div>
        </div>
    </div>

    <div class="ui three steps">
        <div class="step">
        </div>
        <div class="step">
            <div class="content">
                <div class="ui vertical steps">
                    <div class="step" id="contoso">
                        <i class="credit card icon" id="contoso-icon" data-icon="credit card"></i>
                        <div class="content">
                            <div class="title">Contoso, Ltd.</div>
                            <div class="description">We never decline!</div>
                        </div>
                    </div>
                    <div class="step" id="fabrikam">
                        <i class="credit card icon" id="fabrikam-icon" data-icon="credit card"></i>
                        <div class="content">
                            <div class="title">Fabrikam, Inc.</div>
                            <div class="description">Lock your rate in with us!</div>
                        </div>
                    </div>
                    <div class="step" id="woodgrove">
                        <i class="credit card icon" id="woodgrove-icon" data-icon="credit card"></i>
                        <div class="content">
                            <div class="title">Woodgrove Bank</div>
                            <div class="description">Best interest rates in town</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="disabled step">
        </div>
    </div>

    <script>
        function resetView() {
            var steps = ['confirmation', 'reception', 'agencies', 'contoso', 'fabrikam', 'woodgrove'];
            for(i=0; i<steps.length; i++) {
                setStepState(steps[i]);
            }
        }

        function setStepState(step, state) {
            document.getElementById(step).classList.remove('disabled');
            document.getElementById(step).classList.remove('active');
            document.getElementById(step).classList.remove('completed');
            
            if(state) {
                document.getElementById(step).classList.add(state);

                if(state == 'disabled')
                {
                    document.getElementById(step + '-icon').className = 'thumbs down icon';
                }
                if(state == 'completed')
                {
                    document.getElementById(step + '-icon').className = 'thumbs up icon';
                }
            }
            else { // reset icon to original state
                var ogIcon = document.getElementById(step + '-icon').getAttribute('data-icon');
                document.getElementById(step + '-icon').className = '';
                document.getElementById(step + '-icon').className = ogIcon + ' icon';
            }
        }

        function start() {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl('http://localhost:7071/api')
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.on('loanApplicationStart', (loanApplication) => {
                console.log('loan application started');
                console.log(loanApplication);
                resetView();
                document.getElementById('reception').classList.add('active');
            });

            connection.on('loanApplicationReceived', (loanApplication, result) => {
                console.log('loan application started');
                console.log(loanApplication);
                if(result == true)
                {
                    setStepState('reception', 'completed');
                }
                else
                {
                    setStepState('reception', 'disabled');
                }
            });

            connection.on('agencyCheckPhaseStarted', () => {
                setStepState('agencies', 'active');
            });

            connection.on('agencyCheckPhaseCompleted', (result) => {
                if(result == true)
                {
                    setStepState('agencies', 'completed');
                }
                else
                {
                    setStepState('agencies', 'disabled');
                }
            });

            connection.on('agencyCheckStarted', (request) => {
                console.log('agency check started');
                console.log(request);
                setStepState(request.AgencyId, 'active');
            });

            connection.on('agencyCheckComplete', (result) => {
                console.log('agency check complete');
                console.log(result);
                console.log(result.IsApproved == true)
                if(result.IsApproved == true)
                {
                    setStepState(result.AgencyId, 'completed');
                }
                else
                {
                    setStepState(result.AgencyId, 'disabled');
                }
            });

            connection.on('loanApplicationComplete', (result) => {
                console.log('loan application complete');
                console.log(result);
                if(result.IsSuccess == true)
                {
                    setStepState('confirmation', 'completed');
                }
                else
                {
                    setStepState('confirmation', 'disabled');
                }
            });

            connection.start()
                .then(() => { })
                .catch(console.error);
        }
    </script>
</body>

</html>